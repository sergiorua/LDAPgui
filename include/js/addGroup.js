delGroup=function(dataStore,gridPanel){var dataStore=gridPanel.getStore();var u=gridPanel.getSelectionModel().getSelections();if(u.length<1)return(false);Ext.MessageBox.confirm('Message','Are you sure you want to delete this/these Group(s)?',function(btn){var i=0;if(btn!="yes")return(false);for(i=0;i<u.length;i++){Ext.Ajax.request({method:'GET',url:'/group/delete',failure:function(data){action=Ext.util.JSON.decode(data.responseText);Ext.MessageBox.alert('Error',action.info);},success:function(data){var action=Ext.util.JSON.decode(data.responseText);rx=new RegExp(action.group,"g");var i=gridPanel.getStore().find('name',rx);if(i>0){gridPanel.getSelectionModel().selectRow(i);var u=gridPanel.getSelectionModel().getSelected();dataStore.remove(u);}
Ext.MessageBox.alert('Confirmation',action.info);},params:{groupName:u[i].get('name')}});}});}
addGroup=function(dataStore,selectedRow){var groupname=new Ext.form.TextField({fieldLabel:'Group Name',allowBlank:false,name:'groupName',anchor:'90%'});var gidNumber=new Ext.form.TextField({fieldLabel:'GID',allowBlank:true,emptyText:'Leave empty for auto generation',name:'gidNumber',anchor:'90%'});var groupMembersStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:'/user/list',method:'GET',}),reader:new Ext.data.JsonReader({root:'results',},[{name:'firstname'},{name:'surname'},{name:'uid'},{name:'uidNumber'},])});var groupMembersColumns=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"First name",width:130,sortable:true,dataIndex:'firstname'},{header:"Last name",width:130,sortable:true,dataIndex:'surname'},{header:"Username",width:100,sortable:true,dataIndex:'uid'},]);var groupMembersGrid=new Ext.grid.GridPanel({store:groupMembersStore,deferredRender:false,cm:groupMembersColumns,sm:new Ext.grid.RowSelectionModel({singleSelect:false}),width:'100%',height:200,frame:true,iconCls:'icon-grid',name:'members',});var formPanel=new Ext.form.FormPanel({baseCls:'x-plain',labelWidth:100,url:'/group/add',method:'GET',defaultType:'textfield',items:[groupname,gidNumber,groupMembersGrid]});var window=new Ext.Window({title:'Add New LDAP Group to System',width:500,height:330,minWidth:300,minHeight:250,layout:'fit',plain:true,bodyStyle:'padding:5px;',buttonAlign:'center',items:formPanel,buttons:[{text:'Save',handler:function(){if(formPanel.form.isValid()){var memberShip='';var usersList=groupMembersGrid.getSelections();for(i=0;i<usersList.length;i++){memberShip+=usersList[i].get('uid')+",";}
formPanel.form.submit({params:{'members':memberShip},waitMsg:'Saving...',failure:function(form,action){Ext.MessageBox.alert('Error Message',action.result.info);},success:function(form,action){Ext.MessageBox.alert('Confirm',action.result.info);window.destroy();loadGroupsGrid();}});}else{Ext.MessageBox.alert('Errors','Please fix the errors noted.');}}},{text:'Cancel',handler:function(){window.destroy();}}]});window.show();groupMembersStore.load();if(selectedRow){Ext.Ajax.request({url:'/group/get_group',method:'GET',disableCaching:true,params:{gidNumber:selectedRow.get('gid')},success:function(data){var group=Ext.util.JSON.decode(data.responseText);groupname.setValue(group.cn);gidNumber.setValue(group.gidNumber);groupMembersGrid.getSelectionModel().selectAll();var nrows=groupMembersGrid.getSelectionModel().getCount();var rows=groupMembersGrid.getSelectionModel().getSelections();groupMembersGrid.getSelectionModel().clearSelections();userG=group.members.split(":");var selected=new Array();for(i=0;i<nrows;i++){var u=rows[i].get('uid');for(j=0;j<userG.length;j++){if(userG[j]==u){selected.push(i);}}}
groupMembersGrid.getSelectionModel().selectRows(selected);formPanel.getForm()['url']='/group/update';groupname.setDisabled(true);formPanel.getForm().baseParams={'groupName':group.cn};},});}};
